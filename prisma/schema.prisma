generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String          @id @default(uuid())
  username      String?         @unique
  email         String?         @unique
  emailVerified DateTime?       @map("email_verified")
  name          String?
  image         String?
  fullName      String?         @map("full_name")
  avatarUrl     String?         @map("avatar_url")
  website       String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  accounts      Account[]
  blogPosts     BlogPost[]
  chatSessions  ChatSession[]
  documents     Document[]
  exportConfigs ExportConfig[]
  sessions      Session[]
  storageFiles  StorageFile[]
  taskBoards    TaskBoard[]
  taskTags      TaskTag[]
  aiSettings    UserAISettings?
  apiKeys       UserAPIKey[]
  workspaces    Workspace[]

  @@map("user_profiles")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserAISettings {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  defaultProvider String   @default("google") @map("default_provider")
  defaultModel    String   @default("gemini-2.5-flash") @map("default_model")
  temperature     Float    @default(0.8)
  maxTokens       Int      @default(1024) @map("max_tokens")
  systemPrompt    String   @default("You are a helpful AI assistant.") @map("system_prompt")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_ai_settings")
}

model UserAPIKey {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  provider     String
  keyEncrypted String   @map("key_encrypted")
  iv           String
  authTag      String   @map("auth_tag")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@map("user_api_keys")
}

model ChatSession {
  id           String        @id @default(uuid())
  userId       String        @map("user_id")
  title        String        @default("New Chat")
  provider     String        @default("google")
  model        String        @default("gemini-2.5-flash")
  temperature  Float         @default(0.8)
  maxTokens    Int           @default(1024) @map("max_tokens")
  systemPrompt String        @default("You are a helpful AI assistant.") @map("system_prompt")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  messages     ChatMessage[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@index([userId, createdAt(sort: Desc)])
  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(uuid())
  sessionId String      @map("session_id")
  role      String
  content   String
  imageUrl  String?     @map("image_url")
  metadata  Json?
  createdAt DateTime    @default(now()) @map("created_at")
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("chat_messages")
}

model Document {
  id        String       @id @default(uuid())
  userId    String       @map("user_id")
  sessionId String?      @map("session_id")
  title     String
  content   String
  metadata  Json?
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  session   ChatSession? @relation(fields: [sessionId], references: [id])
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  stories   Story[]

  @@index([userId, createdAt(sort: Desc)])
  @@map("documents")
}

model Story {
  id          String   @id @default(uuid())
  documentId  String   @map("document_id")
  title       String
  description String
  acceptance  String?
  priority    String?  @default("medium")
  estimate    Int?
  tags        String[] @default([])
  position    Int      @default(0)
  exported    Boolean  @default(false)
  exportedTo  String?
  externalId  String?  @map("external_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId, position])
  @@map("stories")
}

model ExportConfig {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  platform     String
  accessToken  String   @map("access_token")
  refreshToken String?  @map("refresh_token")
  workspace    String?
  boardId      String?  @map("board_id")
  projectKey   String?  @map("project_key")
  listId       String?  @map("list_id")
  issueType    String?  @default("Story") @map("issue_type")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId])
  @@map("export_configs")
}

model Workspace {
  id             String          @id @default(uuid())
  userId         String          @map("user_id")
  name           String
  icon           String?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  workspacePages WorkspacePage[]
  user           User            @relation(fields: [userId], references: [id])

  @@map("workspaces")
}

model WorkspacePage {
  id          String          @id @default(uuid())
  workspaceId String          @map("workspace_id")
  parentId    String?         @map("parent_id")
  title       String          @default("Untitled")
  content     Json?
  icon        String?
  cover       Json?
  position    Int?
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  parent      WorkspacePage?  @relation("PageHierarchy", fields: [parentId], references: [id])
  children    WorkspacePage[] @relation("PageHierarchy")
  workspace   Workspace       @relation(fields: [workspaceId], references: [id])

  @@map("workspace_pages")
}

model BlogPost {
  id        String     @id @default(uuid())
  userId    String     @map("user_id")
  parentId  String?    @map("parent_id")
  title     String     @default("Untitled")
  content   Json?
  icon      String?
  cover     Json?
  published Boolean    @default(false)
  position  Int?
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  parent    BlogPost?  @relation("PostHierarchy", fields: [parentId], references: [id])
  children  BlogPost[] @relation("PostHierarchy")
  user      User       @relation(fields: [userId], references: [id])

  @@map("blog_posts")
}

model TaskBoard {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  name        String
  icon        String?
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  user        User         @relation(fields: [userId], references: [id])
  taskColumns TaskColumn[]
  tasks       Task[]

  @@map("task_boards")
}

model TaskColumn {
  id        String    @id @default(uuid())
  boardId   String    @map("board_id")
  name      String
  position  Int?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  board     TaskBoard @relation(fields: [boardId], references: [id])
  tasks     Task[]

  @@map("task_columns")
}

model Task {
  id                String              @id @default(uuid())
  boardId           String              @map("board_id")
  columnId          String?             @map("column_id")
  parentId          String?             @map("parent_id")
  title             String
  description       String?
  position          Int?
  dueDate           DateTime?           @map("due_date")
  completed         Boolean             @default(false)
  priority          Int                 @default(0)
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  TaskTagAssignment TaskTagAssignment[]
  board             TaskBoard           @relation(fields: [boardId], references: [id])
  column            TaskColumn?         @relation(fields: [columnId], references: [id])
  parent            Task?               @relation("TaskHierarchy", fields: [parentId], references: [id])
  children          Task[]              @relation("TaskHierarchy")

  @@map("tasks")
}

model TaskTag {
  id                String              @id @default(uuid())
  name              String
  color             String?
  userId            String              @map("user_id")
  createdAt         DateTime            @default(now()) @map("created_at")
  TaskTagAssignment TaskTagAssignment[]
  user              User                @relation(fields: [userId], references: [id])

  @@map("task_tags")
}

model StorageFile {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  bucketName String   @map("bucket_name")
  filePath   String   @map("file_path")
  fileName   String   @map("file_name")
  fileSize   Int?     @map("file_size")
  mimeType   String?  @map("mime_type")
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id])

  @@map("storage_files")
}

model TaskTagAssignment {
  A         String
  B         String
  tasks     Task    @relation(fields: [A], references: [id], onDelete: Cascade)
  task_tags TaskTag @relation(fields: [B], references: [id], onDelete: Cascade)

  @@id([A, B], map: "_TaskTagAssignment_AB_pkey")
  @@index([B], map: "_TaskTagAssignment_B_index")
  @@map("_TaskTagAssignment")
}
